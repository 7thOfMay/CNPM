<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TutorPro</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar">
                <div class="logo">
                    <h1>TutorPro <span style="font-size: 0.8em; opacity: 0.8; color: #ff4757;">Admin</span></h1>
                </div>
                <div class="nav-links">
                    <a href="#dashboard" class="active" onclick="showTab('dashboard')">Overview</a>
                    <a href="#reports" onclick="showTab('reports')">Reports & Transcripts</a>
                    <a href="#messages" onclick="showTab('messages')">Messages <span id="unreadBadge" class="badge hidden">0</span></a>
                    <a href="#notifications" id="notificationsLink">Notifications <span id="notificationBadge" class="badge hidden">0</span></a>
                    <button id="logoutBtn" class="btn btn-small">Logout</button>
                </div>
            </nav>
        </header>

        <main style="padding: 2rem;">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content">
                <div class="dashboard-section">
                    <h3>Platform Statistics</h3>
                    <div id="adminStats" class="stats-grid">
                        <!-- Stats will be loaded here -->
                        <div class="stat-card">
                            <h3>Loading...</h3>
                            <p>Fetching data</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <h3>Key Metrics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalSessions">-</h3>
                            <p>Total Sessions</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="avgRating">-</h3>
                            <p>Avg Rating</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="completionRate">-</h3>
                            <p>Completion Rate</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="activeUsers">-</h3>
                            <p>Active Users</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h3>System Grades Overview</h3>
                    <div id="systemGrades">
                        <p>Loading grades...</p>
                    </div>
                </div>
            </div>

            <!-- Reports & Transcripts Tab -->
            <div id="tab-reports" class="tab-content hidden">
                <div class="dashboard-section">
                    <h3>Reports & Transcripts</h3>
                    
                    <!-- Filters -->
                    <div id="reportFilters" class="filters" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>Semester</label>
                            <select id="reportSemester" onchange="loadAdminReports()">
                                <option value="">All Semesters</option>
                                <option value="HK1">Semester 1</option>
                                <option value="HK2">Semester 2</option>
                                <option value="HK3">Summer Semester</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>Faculty</label>
                            <select id="reportFaculty" onchange="loadAdminReports()">
                                <option value="">All Faculties</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Electrical Engineering">Electrical Engineering</option>
                                <option value="Mechanical Engineering">Mechanical Engineering</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>Role</label>
                            <select id="reportRole" onchange="loadAdminReports()">
                                <option value="student">Students</option>
                                <option value="tutor">Tutors</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="exportReportPDF()">Export PDF</button>
                        </div>
                    </div>

                    <!-- Report Content -->
                    <div id="reportResults">
                        <p>Select filters to view reports.</p>
                    </div>

                    <!-- Transcript View Section (Hidden by default) -->
                    <div id="transcriptView" class="hidden" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <button class="btn btn-secondary" onclick="closeTranscriptView()">Back to Reports</button>
                            <button class="btn btn-primary" onclick="printTranscript()">Print Transcript</button>
                        </div>
                        <div id="transcriptContent" style="border: 1px solid #ccc; padding: 2rem; background: white;">
                            <!-- Transcript details will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="tab-messages" class="tab-content hidden">
                <div class="dashboard-section">
                    <h3>Messages</h3>
                    <div id="adminChatContainer" class="chat-container-main" style="height: 600px;">
                        <div class="chat-sidebar">
                            <h3>Conversations</h3>
                            <div class="chat-user-search">
                                <input type="text" id="userSearch" placeholder="Search users...">
                                <button id="newChatBtn" class="btn btn-primary" style="margin-top: 0.5rem; width: 100%;">New Chat</button>
                            </div>
                            <div id="chatRoomsList" class="chat-rooms-list">
                                <!-- Chat list will be loaded here -->
                            </div>
                        </div>
                        <div class="chat-main">
                            <div id="chatHeader" class="chat-header">
                                <h4>Select a conversation</h4>
                            </div>
                            <div id="chatMessagesArea" class="chat-messages-area">
                                <!-- Messages will be loaded here -->
                            </div>
                            <div id="chatInputArea" class="chat-input-area hidden">
                                <form id="chatMessageForm">
                                    <input type="text" id="chatMessageInput" placeholder="Type a message..." required>
                                    <button type="submit" class="btn btn-primary">Send</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Chat Modal -->
            <div id="newChatModal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Start New Conversation</h3>
                    <div id="availableUsersList" class="users-list-modal"></div>
                </div>
            </div>

            <!-- Notifications Section -->
            <section id="notifications" class="section hidden">
                <h2>Notifications</h2>
                <div class="dashboard-section">
                    <button class="btn btn-secondary" onclick="markAllNotificationsRead()">Mark All as Read</button>
                    <div id="notificationsList" style="margin-top: 1rem;"></div>
                </div>
            </section>

        </main>
    </div>

    <script src="app.js?v=2"></script>
    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
            
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            } else {
                const section = document.getElementById(tabName);
                if (section) section.classList.remove('hidden');
            }

            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${tabName}`) {
                    link.classList.add('active');
                }
            });

            // Load data for specific tabs
            if (tabName === 'messages') {
                if (typeof loadChatRooms === 'function') loadChatRooms();
            } else if (tabName === 'dashboard') {
                if (typeof loadAdminDashboard === 'function') loadAdminDashboard();
            } else if (tabName === 'reports') {
                if (typeof loadAdminReports === 'function') loadAdminReports();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || user.role !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
            
            loadAdminDashboard();
            checkSystemHealth();
        });
    </script>
</body>
</html>

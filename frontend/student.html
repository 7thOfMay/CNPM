<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - TutorPro</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-modal.css">
</head>
<body>
    <div class="container">
        <header>
            <nav class="navbar">
                <div class="logo">
                    <h1>TutorPro <span style="font-size: 0.8em; opacity: 0.8;">Student</span></h1>
                </div>
                <div class="nav-links">
                    <a href="#dashboard" class="active" onclick="showTab('dashboard')">Dashboard</a>
                    <a href="#courses" onclick="showTab('courses')">Courses</a>
                    <a href="#schedule" onclick="showTab('schedule')">Schedule</a>
                    <a href="#profile" onclick="showTab('profile')">Profile</a>
                    <a href="#chat" id="chatLink" onclick="showTab('chat')">Messages <span id="unreadBadge" class="badge hidden">0</span></a>
                    <a href="#notifications" id="notificationsLink" onclick="showTab('notifications')">Notifications <span id="notificationBadge" class="badge hidden">0</span></a>
                    <button id="logoutBtn" class="btn btn-small">Logout</button>
                </div>
            </nav>
        </header>

        <main style="padding: 2rem;">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content">
                <div class="dashboard-section">
                    <h3>My Enrolled Courses</h3>
                    <div id="myEnrolledCourses" class="courses-grid"></div>
                </div>
            </div>

            <!-- Courses Tab -->
            <div id="tab-courses" class="tab-content hidden">
                <div class="dashboard-section">
                    <h3>Available Courses</h3>
                    <div class="filters">
                        <select id="studentSubjectFilter" onchange="filterStudentCourses()">
                            <option value="">All Subjects</option>
                            <option value="math">Mathematics</option>
                            <option value="science">Science</option>
                            <option value="programming">Programming</option>
                        </select>
                        <select id="studentLevelFilter" onchange="filterStudentCourses()">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div id="studentCoursesList" class="courses-grid"></div>
                </div>
                <div class="dashboard-section">
                    <h3>Learning Resources</h3>
                    <div id="studentResourcesList" class="resource-list"></div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="tab-schedule" class="tab-content hidden">
                <div class="dashboard-section">
                    <h3>My Schedule</h3>
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-primary" onclick="toggleCalendarView()">
                            <span id="viewToggleText">Calendar View</span>
                        </button>
                    </div>
                    <div id="calendarView" class="calendar-container hidden"></div>
                    <div id="studentSchedule" class="schedule-list"></div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="tab-profile" class="tab-content hidden">
                <div class="dashboard-section" style="background: transparent; box-shadow: none; padding: 0;">
                    <div class="profile-container" style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; align-items: start;">
                        <!-- Left Column: Identity -->
                        <div class="profile-sidebar" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: var(--shadow-sm); text-align: center;">
                            <div class="profile-avatar" style="width: 120px; height: 120px; margin: 0 auto 1.5rem; font-size: 3rem; display: flex; align-items: center; justify-content: center; background: var(--primary-blue); color: white; border-radius: 50%;">
                                <span id="profileAvatarInitials">--</span>
                            </div>
                            <h2 id="profileName" style="font-size: 1.5rem; margin-bottom: 0.5rem;">Loading...</h2>
                            <p id="profileEmail" style="color: var(--text-secondary); margin-bottom: 1rem;">loading...</p>
                            <div id="profileRole" class="role-badge" style="margin-bottom: 2rem; display: inline-block;">Student</div>
                            
                            <div style="text-align: left; border-top: 1px solid var(--border-light); padding-top: 1.5rem;">
                                <div class="form-group">
                                    <label style="font-size: 0.9rem; color: var(--text-secondary);">Student ID</label>
                                    <input type="text" id="profileStudentId" disabled style="background: transparent; border: none; font-weight: 600; color: var(--text-primary); padding: 0; width: 100%;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 0.9rem; color: var(--text-secondary);">Faculty</label>
                                    <input type="text" id="profileFaculty" disabled style="background: transparent; border: none; font-weight: 600; color: var(--text-primary); padding: 0; width: 100%;">
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Edit Form -->
                        <div class="profile-content" style="background: white; padding: 2.5rem; border-radius: 8px; box-shadow: var(--shadow-sm);">
                            <h3 style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light);">Edit Profile</h3>
                            <form id="profileForm" onsubmit="handleProfileUpdate(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div class="form-group">
                                        <label>Phone Number</label>
                                        <input type="tel" id="profilePhone" placeholder="Enter phone number">
                                    </div>
                                    <div class="form-group">
                                        <label>Address</label>
                                        <input type="text" id="profileAddress" placeholder="Enter address">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Bio</label>
                                    <textarea id="profileBio" rows="5" placeholder="Tell us about yourself..."></textarea>
                                </div>
                                <div style="text-align: right;">
                                    <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem;">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Section (Hidden by default, shown via app.js logic) -->
            <section id="chat" class="section hidden">
                <h2>Messages</h2>
                <div class="chat-container-main">
                    <div class="chat-sidebar">
                        <h3>Conversations</h3>
                        <div class="chat-user-search">
                            <input type="text" id="userSearch" placeholder="Search users...">
                            <button id="newChatBtn" class="btn btn-primary">New Chat</button>
                        </div>
                        <div id="chatRoomsList" class="chat-rooms-list"></div>
                    </div>
                    <div class="chat-main">
                        <div id="chatHeader" class="chat-header">
                            <p>Select a conversation to start messaging</p>
                        </div>
                        <div id="chatMessagesArea" class="chat-messages-area"></div>
                        <div id="chatInputArea" class="chat-input-area hidden">
                            <form id="chatMessageForm">
                                <input type="text" id="chatMessageInput" placeholder="Type a message..." required>
                                <button type="submit" class="btn btn-primary">Send</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- New Chat Modal -->
                <div id="newChatModal" class="modal hidden">
                    <div class="modal-content">
                        <span class="close-modal">&times;</span>
                        <h3>Start New Conversation</h3>
                        <div id="availableUsersList" class="users-list-modal"></div>
                    </div>
                </div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="section hidden">
                <h2>Notifications</h2>
                <div class="dashboard-section">
                    <button class="btn btn-secondary" onclick="markAllNotificationsRead()">Mark All as Read</button>
                    <div id="notificationsList" style="margin-top: 1rem;"></div>
                </div>
            </section>

        </main>
    </div>

    <!-- Course Details Modal for Students -->
    <div id="studentCourseDetailsModal" class="modal hidden">
        <div class="modal-content large-modal">
            <span class="close-modal" onclick="closeStudentCourseDetails()">&times;</span>
            <h2 id="studentModalCourseTitle">Course Details</h2>
            
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchStudentModalTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchStudentModalTab('resources')">Resources</button>
            </div>

            <div id="studentModalTab-overview" class="modal-tab-content">
                <div class="detail-group">
                    <label>Tutor:</label>
                    <span id="studentModalTutorName">Loading...</span>
                </div>
                <div class="detail-group">
                    <label>Your Grade:</label>
                    <span id="studentModalGrade" class="grade-badge">Loading...</span>
                </div>
                <div class="detail-group">
                    <label>Attendance Progress:</label>
                    <div class="progress-bar-container">
                        <div id="studentModalProgressBar" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <span id="studentModalProgressText">0/0 Sessions</span>
                </div>
            </div>

            <div id="studentModalTab-resources" class="modal-tab-content hidden">
                <div id="studentModalResourcesList" class="resource-list">
                    <!-- Resources will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Enrollment Confirmation Modal -->
    <div id="enrollmentModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEnrollmentModal()">&times;</span>
            <h2>Register for Tutor Program</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Please confirm your registration details. Data will be synchronized with HCMUT_DATACORE.</p>
            
            <div class="dashboard-section" style="background: #F9FAFB; border: 1px solid #E2E8F0;">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="width: 8px; height: 8px; background: #10B981; border-radius: 50%; margin-right: 8px;"></div>
                    <span style="font-size: 0.9rem; font-weight: 600; color: #059669;">HCMUT_SSO Verified</span>
                </div>
                
                <div class="form-group" style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.85rem;">Student Name</label>
                    <div id="confirmStudentName" style="font-weight: 600;">Loading...</div>
                </div>
                <div class="form-group" style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.85rem;">Student ID</label>
                    <div id="confirmStudentId" style="font-weight: 600;">Loading...</div>
                </div>
                <div class="form-group" style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.85rem;">Faculty</label>
                    <div id="confirmFaculty" style="font-weight: 600;">Loading...</div>
                </div>
                <div class="form-group">
                    <label style="font-size: 0.85rem;">Program/Course</label>
                    <div id="confirmCourseName" style="font-weight: 600; color: var(--primary-blue);">Loading...</div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeEnrollmentModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEnrollment()">Confirm Registration</button>
            </div>
        </div>
    </div>

    <!-- Tutor Selection Modal -->
    <div id="tutorSelectionModal" class="modal hidden">
        <div class="modal-content large-modal">
            <span class="close-modal" onclick="closeTutorSelectionModal()">&times;</span>
            <h2>Select a Tutor</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Choose a tutor for your course or let us match you automatically.</p>
            
            <div style="margin-bottom: 1.5rem; text-align: center;">
                <button class="btn btn-secondary" onclick="handleAutoSelectTutor()" style="width: 100%; padding: 1rem; border: 2px dashed var(--primary-blue); color: var(--primary-blue); font-weight: 600;">
                    âœ¨ Auto-Select Tutor (Random Match)
                </button>
            </div>

            <div id="availableTutorsList" class="courses-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                <!-- Tutors will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeRatingModal()">&times;</span>
            <h2>Rate Session</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Please evaluate your tutor based on the following criteria (0-10).</p>
            
            <form id="ratingForm" onsubmit="handleRatingSubmit(event)">
                <div class="form-group">
                    <label>Communication (0-10)</label>
                    <input type="number" id="rateComm" min="0" max="10" required>
                </div>
                <div class="form-group">
                    <label>Expertise (0-10)</label>
                    <input type="number" id="rateExpertise" min="0" max="10" required>
                </div>
                <div class="form-group">
                    <label>Punctuality (0-10)</label>
                    <input type="number" id="ratePunctuality" min="0" max="10" required>
                </div>
                <div class="form-group">
                    <label>Comments (Optional)</label>
                    <textarea id="rateComment" rows="3" placeholder="Share your experience..."></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeRatingModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js?v=2"></script>
    <script>
        // Tab switching logic
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
            
            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                
                // Refresh data when switching to dashboard
                if (tabName === 'dashboard') {
                    if (typeof loadEnrolledCourses === 'function') {
                        loadEnrolledCourses();
                    }
                }
                
                if (tabName === 'profile') {
                    if (typeof loadProfile === 'function') {
                        loadProfile();
                    }
                }
            } else {
                // If it's a section (like chat or notifications)
                const section = document.getElementById(tabName);
                if (section) section.classList.remove('hidden');
            }

            // Update nav active state
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${tabName}`) {
                    link.classList.add('active');
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth
            const userStr = localStorage.getItem('currentUser');
            const token = localStorage.getItem('authToken');
            
            if (!userStr || !token) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userStr);
                if (user.role !== 'student') {
                    window.location.href = 'login.html';
                    return;
                }
            } catch (e) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load initial data
            loadStudentDashboard();
        });
    </script>
</body>
</html>
